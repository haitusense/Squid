<html lang="en">
<head>
  <meta charset="UTF-8">
</head>

<style type="text/css">
  .svg-container {
    height: 90px;
    overflow: hidden;
  }
  div { height: 30px; }
  label { float: left; width: 200px;}
  input { float: left; width: 200px;}
</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
<script> mermaid.initialize({  startOnLoad:false, });
</script>

<body>
  <div>sample</div>
  <div>
    <input id="id1_in" type="text" name="value" value="default_1"/>
    <input type="button" value="myfunc1" onclick="myfunc1()"/>
    <input id="id1_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div class="svg-container" id="mermaid"></div>
  <div>
    <input id="id2_in" type="text" name="value" value="default_2"/>
    <input type="button" value="hostObjects to MessageBox" onclick="myfunc2()"/>
  </div>
  <div>
    <input id="id3_in" type="text" name="value" value="default_3"/>
    <input type="button" value="postMessage to Status" onclick="myfunc3()"/>
  </div>
  <div>
    <input id="id4_in" type="text" name="value" value="default_4"/>
    <input type="button" value="hostObjects to CallProcess" onclick="myfunc4()"/>
    <input id="id4_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id5_in" type="text" name="value" value="default_4"/>
    <input type="button" value="Write to MM" onclick="myfunc5()"/>
  </div>
  <div>
    <input id="id6_out" type="text" name="value" disabled="disabled"/>
    <input type="button" value="Read from MM" onclick="myfunc6()"/>
    <input id="id6_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id7_in" type="text" name="value" value="selenium" disabled="disabled"/>
    <input type="button" value="Call Selenium Process" onclick="myfunc7()"/>
    <input id="id7_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id8_in" type="text" name="value" value="data.raw"/>
    <input type="button" value="Call OpenCV Process" onclick="myfunc8()"/>
    <input id="id8_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id9_in" type="text" name="value" disabled="disabled"/>
    <input type="button" value="Call R Process" onclick="myfunc9()"/>
    <input id="id9_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div id="plot_svg" style="height: 180px;">
  </div>
  <div>
    <input id="id10_in" type="text" name="value" disabled="disabled"/>
    <input type="button" value="Cancel" onclick="myfunc10()"/>
    <input id="id10_out" type="text" name="value" disabled="disabled"/>
  </div>
</body>

<script>

// addEventListener DOMContentLoaded
window.addEventListener('DOMContentLoaded', async () =>{
  console.log(ConsoleColor.green('DOMContentLoaded'));
  
  console.log(ConsoleColor.green('regist memorymap'));
  chrome.webview.hostObjects.Squid.OpenMemoryMap("mmf", 10);

  console.log(ConsoleColor.green('regist pipe'));
  chrome.webview.hostObjects.Squid.OpenPipe("NamedPipe");

  let graphDefinition = buildgraph("aaa", "black");
  const { svg } = await mermaid.render('svg_1', graphDefinition);
  document.getElementById("mermaid").innerHTML = svg;
  const svgElement = document.getElementById('svg_1');
  svgElement.setAttribute('height', '100%');
});

// addEventListener webview message
if(window.chrome.webview){
  window.chrome.webview.addEventListener('message', (e) => {
    let json = e.data;
    switch(json.key){
      case "message":
        console.log(`from cs ${json.key} : ${ConsoleColor.yellow(json.value)}`);
        break;
      case "json":
        console.log(`from cs ${json.key}`);
        console.log(json.value);
        if(json.value.id == "plot_svg"){
          document.getElementById(json.value.id).innerHTML = json.value.value;
        }else{
          document.getElementById(json.value.id).value = json.value.value;
        }
        break;
      default:
        console.log(`from cs ${json.key}`);
        console.log(e);
    }
  });
}

var buildgraph = (val, color) => {
  return `flowchart LR
    A[Hard] -->|a| B(${val})
    B  -->C{Decision}
    C -->|b| D[Result 1]
    C -->|c| E[Result 2]
    style B color:${color}
  `;
}

// Event
var myfunc1 = async () => {
  console.log("myfunc1");
  var src = document.getElementById("id1_in").value;
  document.getElementById("id1_out").value = src;

  let graphDefinition = buildgraph(src, "red");
  //   document.getElementById("mermaid_1").textContent = str4;
  //   await mermaid.run({
  //     querySelector: '.mermaid',
  //   });
  const { svg } = await mermaid.render('svg_1', graphDefinition);
  document.getElementById("mermaid").innerHTML = svg;
  const svgElement = document.getElementById('svg_1');
  svgElement.setAttribute('height', '100%');
}

var myfunc2 = function(){
  console.log("myfunc2");
  var src = document.getElementById("id2_in").value;
  chrome.webview.hostObjects.Squid.ShowMessageBox('call .net object :' + src);
}

var myfunc3 = function(){
  console.log("myfunc3");
  var elem = document.getElementById("id3_in").value;
  console.log(elem);
  window.chrome.webview.postMessage(elem);
}

// resultはFunc(), 同期的にうごくのでUIはロック。Taskは待ってくれない
var myfunc4 = async function() {
  console.log("myfunc4");
  const squid = chrome.webview.hostObjects.Squid;
  let result = squid.CallProcessAsync("dotnet", "script ./main.csx", "myfunc4_callback()");
  result.then((res) => {
    document.getElementById("id4_out").value = "doing";
  });
}
var myfunc4_callback = () => {
  console.log("myfunc4 done")
  document.getElementById("id4_out").value = "done";
}


var myfunc5 = async function() {
  const squid = chrome.webview.hostObjects.Squid;
  squid.WriteMemoryMap(JSON.stringify([4,3,2,1,0]));
}

var myfunc6 = async function() {
  const squid = chrome.webview.hostObjects.Squid;
  let result = await squid.ReadMemoryMap();
  console.log(typeof(result));
  console.log(result);
  // result.then((res) => {
  //   var elem = document.getElementById("id4");
  //   elem.innerHTML = "doing";
  // });
}

var myfunc7 = async function() {
  console.log("myfunc7");
  const squid = chrome.webview.hostObjects.Squid;
  let result = squid.CallProcessAsync("dotnet", "script ./selenium.csx", "myfunc7_callback()");
  result.then((res) => { document.getElementById("id7_out").value = "doing"; });
}
var myfunc7_callback = () => {
  console.log("myfunc7 done")
}

var myfunc8 = async function() {
  console.log("myfunc8");
  const squid = chrome.webview.hostObjects.Squid;
  let result = squid.CallProcessAsync("dotnet", "script ./opencv.csx", "myfunc8_callback()");
  result.then((res) => { document.getElementById("id8_out").value = "doing"; });
}
var myfunc8_callback = () => {
  console.log("myfunc8 done")
}

var myfunc9 = async function() {
  console.log("myfunc9");
  const squid = chrome.webview.hostObjects.Squid;
  let result = squid.CallProcessAsync(
    "C:/Program Files/R/R-4.2.3/bin/x64/Rscript.exe", 
    "../sample/script.r",
    "myfunc9_callback()");
  result.then((res) => { document.getElementById("id9_out").value = "doing"; });
}
var myfunc9_callback = () => {
  console.log("myfunc9 done")
}

var myfunc10 = async () => {
  console.log(green + 'cancel pipe' + reset);
  await chrome.webview.hostObjects.Squid.CancelPipe();
}
</script>
</html>