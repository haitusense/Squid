<html lang="en">
<head>
  <meta charset="UTF-8">
</head>

<style type="text/css">
  div { height: 30px; }
  label { float: left; width: 200px;}
  canvas {
    width: 640px;
    height: 480px;
    image-rendering: pixelated;
  }
  #stalker {
    pointer-events: none;
    position: fixed;
    top: 12px;
    left: 18px;
    transform: translate(0, 0);
    background: #eee;
    z-index: 800;
  }
</style>

<body>
  <div>
    <input type="button" value="reset" onclick="reset()"/>
    <input type="button" value="run" onclick="run()"/>
  </div>
  <canvas id="canvas" width="640" height="480">
    <div id="stalker"></div>
  </canvas>
</body>

<script>

// addEventListener DOMContentLoaded
window.addEventListener('DOMContentLoaded', async () =>{
  console.log('DOMContentLoaded');
  console.log('regist memorymap');
  chrome.webview.hostObjects.Squid.OpenMemoryMap("mmf", 640*480);
});

function pick(event, destination) {
  var x = event.layerX;
  var y = event.layerY;
  var pixel = ctx.getImageData(x, y, 1, 1);
  var data = pixel.data;

  const rgba = `rgba(${data[0]}, ${data[1]}, ${data[2]}, ${data[3] / 255})`;
  // destination.style.background = rgba;
  // destination.textContent = rgba;
  var stalker = document.getElementById('stalker');
  stalker.textContent = rgba;
  return rgba;
}
var canvas = document.getElementById('canvas');
// canvas.addEventListener('mousemove', function(event) {
//   pick(event, hoveredColor);
// });

// addEventListener webview message
if(window.chrome.webview){
  window.chrome.webview.addEventListener('message', (e) => {
    var json = e.data;
    switch(json.key){
      case "message":
        console.log(json.value);
        break;
      case "json":
        console.log(json.value);
        // document.getElementById(json.value.id).value = json.value.value;
        break;
      default:
        console.log(e.data);
    }
  });
}

// Event
var reset = async function() {
  SquidJS.Draw('canvas')
}

var draw = async function() {
  const squid = chrome.webview.hostObjects.Squid;
  let result = await squid.ReadMemoryMap();
  SquidJS.DrawFromInt32('canvas', result)
}

var run = async function() {
  const squid = chrome.webview.hostObjects.Squid;
  let json = JSON.stringify({ "mmf" : "mmf" });
  let result = squid.CallProcessAsync("dotnet", `script ./viewer.csx -- "${JSON.stringify(json)}" `, "callback()");
  result.then((res) => {  });
}
var callback = async () => { await draw(); }

</script>
</html>