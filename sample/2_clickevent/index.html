<html lang="en">
<head>
  <meta charset="UTF-8">
</head>

<style type="text/css">
  .svg-container {
    height: 90px;
    overflow: hidden;
  }
  div { height: 30px; }
  label { float: left; width: 200px;}
  input { float: left; width: 200px;}
</style>

<body>
  <div>sample</div>
  <div>
    <input id="id1_in" type="text" name="value" value="default_1"/>
    <input type="button" value="myfunc1" onclick="myfunc1()"/>
    <input id="id1_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id2-1_in" type="text" name="value" value="default_2"/>
    <input type="button" value="hostObjects to MessageBox 1" onclick="myfunc2_1()"/>
  </div>
  <div>
    <input id="id2-2_in" type="text" name="value" value="default_2"/>
    <input type="button" value="hostObjects to MessageBox 2" onclick="myfunc2_2()"/>
    <input id="id2-2_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id3_in" type="text" name="value" value="default_3"/>
    <input type="button" value="postMessage to Status" onclick="myfunc3()"/>
  </div>
  <div>
    <input id="id4_in" type="text" name="value" value="default_4"/>
    <input type="button" value="hostObjects to CallProcess" onclick="myfunc4()"/>
    <input id="id4_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id5_in" type="text" name="value" value="default_5"/>
    <input type="button" value="Write to MM" onclick="myfunc5()"/>
  </div>
  <div>
    <input id="id6_in" type="text" name="value" disabled="disabled"/>
    <input type="button" value="Read from MM" onclick="myfunc6()"/>
    <input id="id6_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id7_in" type="text" name="value" value="selenium" disabled="disabled"/>
    <input type="button" value="Call Selenium Process" onclick="myfunc7()"/>
    <input id="id7_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id8_in" type="text" name="value" disabled="disabled"/>
    <input type="button" value="Call R Process" onclick="myfunc8()"/>
    <input id="id8_out" type="text" name="value" disabled="disabled"/>
  </div>
  <div>
    <input id="id9_in" type="text" name="value" disabled="disabled"/>
    <input type="button" value="CancelPipe" onclick="myfunc10()"/>
    <input id="id9_out" type="text" name="value" disabled="disabled"/>
  </div>
</body>

<script>

// addEventListener DOMContentLoaded
window.addEventListener('DOMContentLoaded', async () =>{
  console.log(ConsoleColor.green('DOMContentLoaded'));
  
  console.log(ConsoleColor.green('regist memorymap'));
  // chrome.webview.hostObjects.Squid.OpenMemoryMap("mmf", 10);
  chrome.webview.hostObjects.Squid.OpenMemoryMap("mmf", 10, "int");

  console.log(ConsoleColor.green('regist pipe'));
  chrome.webview.hostObjects.Squid.OpenNamedPipe("NamedPipe");
});

// addEventListener webview message
if(window.chrome.webview){
  window.chrome.webview.addEventListener('message', (e) => {
    let json = e.data;
    switch(json.key){
      case "message":
        console.log(`from cs ${json.key} : ${ConsoleColor.yellow(json.value)}`);
        break;
      case "json":
        console.log(`from cs ${json.key}`);
        console.log(json.value);
        if(json.value.id == "plot_svg"){
          // document.getElementById(json.value.id).innerHTML = json.value.value;
        }else{
          document.getElementById(json.value.id).value = json.value.value;
        }
        break;
      default:
        console.log(`from cs ${json.key}`);
        console.log(e);
    }
  });
}

// Event
const myfunc1 = async () => {
  console.log("myfunc1");
  var src = document.getElementById("id1_in").value;
  document.getElementById("id1_out").value = src;
}

const myfunc2_1 = () => {
  console.log("myfunc2");
  var src = document.getElementById("id2-1_in").value;
  chrome.webview.hostObjects.Squid.ShowMessageBoxLite('call .net object :' + src);
}
const myfunc2_2 = async () => {
  console.log("myfunc2");
  var src = document.getElementById("id2-2_in").value;
  /*
    Cancel : 2
    No     : 7
    None   : 0
    OK     : 1
    Yes    : 6
  */
  let result = await chrome.webview.hostObjects.Squid.ShowMessageBox(
    'call .net object' + src,
    'caption',
    'YesNoCancel',
    'Information',
    'OK'
    );
  document.getElementById("id2-2_out").value = result;
}

const myfunc3 = function(){
  console.log("myfunc3");
  var elem = document.getElementById("id3_in").value;
  console.log(elem);
  window.chrome.webview.postMessage(elem);
}


const myfunc4 = async function() {
  console.log("myfunc4");
  const squid = chrome.webview.hostObjects.Squid;
  await squid.CallProcessAsync(
    "dotnet",
    "script ./main.csx",
    true, "myfunc4_callback()"
  );
  document.getElementById("id4_out").value = "doing";
}
const myfunc4_callback = () => {
  console.log("myfunc4 done")
  document.getElementById("id4_out").value = "done";
}


const myfunc5 = async function() {
  const squid = chrome.webview.hostObjects.Squid;
  squid.WriteMemoryMap([4,3,2,1,0], "int");
}

const myfunc6 = async function() {
  const squid = chrome.webview.hostObjects.Squid;
  let result = await squid.ReadMemoryMap();
  // console.log(typeof(result));
  console.log(result);
  // result.then((res) => {
  //   var elem = document.getElementById("id4");
  //   elem.innerHTML = "doing";
  // });
}

const myfunc7 = async function() {
  console.log("myfunc7");
  const squid = chrome.webview.hostObjects.Squid;
  let result = squid.CallProcessAsync(
    "dotnet",
    "script ./selenium.csx",
    true,
    "myfunc7_callback()");
  result.then((res) => { document.getElementById("id7_out").value = "doing"; });
}
const myfunc7_callback = () => {
  console.log("myfunc7 done")
}


const myfunc8 = async function() {
  console.log("myfunc8");
  const squid = chrome.webview.hostObjects.Squid;
  let args = { id : "id8_out" } 
  let result = await squid.CallProcessAsync(
    "C:/Program Files/R/R-4.3.1/bin/x64/Rscript.exe", 
    `./script.r ${JSON.stringify(JSON.stringify(args))}`,
    true ,
    "myfunc8_callback()");
  console.log("doing")
  document.getElementById("id8_out").value = "doing";
}
const myfunc8_callback = () => { console.log("myfunc8 done") }

const myfunc9 = async () => {
  console.log(green + 'cancel pipe' + reset);
  await chrome.webview.hostObjects.Squid.CancelPipe();
}

</script>
</html>